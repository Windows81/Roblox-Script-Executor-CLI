# TODO: test EasyExploits API.
import executors.base as base
import requests
import clr

clr.AddReference("EasyExploits")  # type: ignore
import EasyExploits  # type: ignore


class api_eze(base.api_base):
    def restart(self) -> None:
        self.ex = EasyExploits.Module()
        self.ex.LaunchExploit()
        if not self.is_attached():
            raise RuntimeError("Unable to inject EasyExploits API.")
        super().restart()

    def exec(self, script: str) -> None:
        if not self.is_attached():
            raise RuntimeError("EasyExploits API is not injected.")
        self.ex.ExecuteScript(script)

    def is_attached(self) -> bool:
        return self.ex.isInjected()


class api_eze_dll(base.api_inj, base.api_upd):
    FILE_PATH = "EasyExploitsDLL.dll"
    MODULE_URL = "https://easyexploits.com/Module"
    PIPE_NAME = "ocybedam"

    def update(self) -> None:
        data = requests.get(self.MODULE_URL).content.splitlines()
        if data[2] != "true":
            raise FileNotFoundError()

        url = data[0]
        with open(self.FILE_PATH, "wb") as f:
            f.write(requests.get(url).content)
